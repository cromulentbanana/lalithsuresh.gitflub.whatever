---
layout: post
title: Setting up MRTG for BSNL, Jaipur.
categories: []
tags: []
status: publish
type: post
published: true
meta:
  blogger_blog: gettaloadothis.blogspot.com
  blogger_author: Lalithhttp://www.blogger.com/profile/04686418420369403785noreply@blogger.com
  blogger_permalink: /2008/06/setting-up-mrtg-for-bsnl-jaipur.html
  _elasticsearch_indexed_on: '2008-06-06 03:55:00'
---
 	 	 	 	 	 	 	 	<!-- 		@page { size: 21cm 29.7cm; margin: 2cm } 		P { margin-bottom: 0.21cm } 	--><p style="margin-bottom:0;">I finally took my network monitoring work up a level when Gaur sir asked me to go over to the BSNL head office and set up a MRTG server for the NIB (National Internet Backbone). What an opportunity! <span style="color:rgb(0, 0, 153);">MRTG</span> is Tobi Oetiker's (the man behind <span style="color:rgb(0, 0, 153);">RRD Tools</span> and <span style="color:rgb(0, 0, 153);">Smokeping</span>) <span style="color:rgb(0, 0, 153);">multi router traffic grapher</span> which is basically a tool to tell how much bandwidth your routers are using. This seems crucial for an ISP like BSNL who keep getting calls from their customers who b**** about not getting enough bandwidth. And it's really important that they have such a set up since all broadband connections to the state of Rajasthan originate from the Jaipur node where I was asked to work. I'd decided to deploy my ever favourite linux distro, Debian Etch on their server so that <span style="color:rgb(0, 0, 153);">apt-get</span> would make quick work out of the task at hand. Here's the roadmap I'd laid down for myself for the job:</p> <p style="margin-bottom:0;">
<br /></p> <ol><li><p style="margin-bottom:0;">Install a base Debian Etch-4.0.r1 	with a netinstall with a fairly large and separate <span style="color:rgb(0, 0, 153);">/var</span> partition 	since all the <span style="color:rgb(0, 0, 153);">.png</span> files generated by MRTG are dumped into <span style="color:rgb(0, 0, 153);">/var</span>.</p> 	</li><li><p style="margin-bottom:0;">Since security is an important 	issue at such a level, a <span style="color:rgb(0, 0, 153);">dist-upgrade</span> is necessary which is meant to 	patch the OpenSSL security flaw that was found in Debian a couple of 	weeks back.</p> 	</li><li><p style="margin-bottom:0;">Use <span style="color:rgb(0, 0, 153);">apt-get install apache2</span> to set 	up a webserver and configure it as needed.</p> 	</li><li><p style="margin-bottom:0;">Use <span style="color:rgb(0, 0, 153);">apt-get install mrtg snmpd</span> to 	set up MRTG and SNMP and the required dependencies.</p> 	</li><li><p style="margin-bottom:0;">Setup <span style="color:rgb(0, 0, 153);">.htaccess</span> for MRTG so that 	only privileged users can view the graphs.</p> 	</li><li><p style="margin-bottom:0;">Estimated time: 1.5 hours at the 	max.</p> </li></ol> <p style="margin-bottom:0;">
<br /></p> <p style="margin-bottom:0;">Since I was told not to go alone, I took Yash along with me. We reached the BSNL head office at around 10:45 in the morning and after a scouring the whole office complex for around half an hour, we finally met Mr S.C Gupta, the head of the NIB (National Internet Backbone) in Jaipur. He guided us to his office and then led us into their server room which housed some seriously wicked routers and a couple of not-so-wicked servers. Quite expected actually. He showed us the server we were supposed to work on. I don't even think it was a server class machine. He'd already tried to follow the instruction manual that each head office had been sent so as to (or hoping so as to) set up MRTG on their own, and had installed <span style="color:rgb(0, 0, 153);">Red Hat 7.1</span> (LOL) in it by himself as per the manual. At first, I exclaimed “Are these guys kidding me?”. But as the reader of this story will soon find out, the joke was on me. :(</p> <p style="margin-bottom:0;">
<br /></p> <p style="margin-bottom:0;">I proceeded to tell Mr S.C Gupta how much Debian rules and how it's the ultimate combination of security and stability and is pretty much the best choice for running servers. He was kind of pleased with our idea and told him that the machine was all ours and we're free to do whatever it takes to get the job done. Roger that! So we proceeded to do the necessary pings to see if the server was connected to the internet and then noted down the IP address, netmask, the default gateway and the routes. Then we booted our Debian net install disc and went on with the usual procedure, did the partitioning, set up the time zones blah blah blah and set up a static IP configuration. We kidded about how this is going to be piece of cake but I guess we had spoken a moment too soon because the installer complained that it couldn't connect to <a href="ftp://ftp.iitm.ac.in/">ftp.iitm.ac.in</a> to fetch packages. WTF? This was definitely a bad omen. I wondered if we'd set the network interface up correctly and we had. But it just refused to recognize the mirror. So we decided to fetch the packages ourselves after we properly configured the card once the installation of the base system was over. As soon as that was done, we realized we simply could NOT ping any host outside the LAN (after having a hell lot of problems being identified within the LAN itself, we couldn't ping our machine from other machines).  What followed was a lot of trips to Mr Gupta's computer and back to see if he's given us the right details about the network which was followed by an exchange of calls between us and Gaur sir who suggested that IP forwarding wasn't enabled. It seemed kind of odd since I ran the netmon machines from this very installation disc. Then I tried it with my own Debian installed laptop but in vain. I just could not see any host outside the LAN. After a lot of attempts and reinstalls, we decided enough was enough and moved on to install Red Hat 7.1 itself :(. Yuck. I was kind of embarrassed actually. After all the hype I created around Debian. Sad.</p> <p style="margin-bottom:0;">
<br /></p> <p style="margin-bottom:0;">What was supposed to be just a matter of two commands in Debian was indeed a herculean task in Red Hat. We had to fetch each of MRTG's dependencies from the net, compile and install them from source, not to mention having to manually include and link the necessary files and libraries in each case. After using <span style="color:rgb(0, 0, 153);">links</span>, the text based web browser we all know and love, we were able to find out the latest and available versions for <span style="color:rgb(0, 0, 153);">zlib</span>, <span style="color:rgb(0, 0, 153);">gd</span> and <span style="color:rgb(0, 0, 153);">libpng</span> and we successfully installed them from source inspite of having to do a lot of including and linking. Then when it was time to install MRTG, the connection of ours went down and we got awesome transfer rates of around 0-30 bytes per second. Since I hadn't brought another set of clothes, a sleeping bag and a shaving kit for myself, I decided to <span style="color:rgb(0, 0, 153);">ssh</span> into our college network, download it from my netmon server and <span style="color:rgb(0, 0, 102);">scp</span> it over to the BSNL machine and it worked like a charm. After the MRTG package was ready, it's configuration files made, the HTML template created and the MRTG binary scheduled to run every five minutes using <span style="color:rgb(0, 0, 153);">crontab</span>, we decided to test it. And it seemed the rotten luck which had been following us all day wasn't going to make itself scarce any time soon. We couldn't open the apache test page from Mr Gupta's browser. We ran a lot of checks on our <span style="color:rgb(0, 0, 153);">httpd.conf</span> and everything seemed normal. The permissions were perfect and the ownership required etc were all fine. We even tried setting up a virtual host for the job but even that was in vain. Finally, the idea dawned upon me that the firewall we'd set during installation time was set to block all incoming connections to the machine. After permitting <span style="color:rgb(0, 0, 153);">www (http)</span> requests to the machine and adding the prescribed set of <span style="color:rgb(0, 0, 153);">ipchains</span> rules, the server was good to go! We moved on to set up the finishing touches to the machine, making sure things worked even after a reboot. We then set up .htaccess and added a line to the html file saying that the maintainer was Mr S.C Gupta. Job's done!</p> <p style="margin-bottom:0;">
<br /></p> <p style="margin-bottom:0;font-weight:bold;">Estimated time: 1.5 hours max.</p> <p style="margin-bottom:0;font-weight:bold;">Actual time taken: 6.5 hours flat!</p> <p style="margin-bottom:0;">
<br /></p> <p style="margin-bottom:0;">All in all, an interesting experience, having had to work in a real live environment. After the ordeal, we realised we were pretty hungry because we were NOT given a single bite at the office. I went on to mow down 6 or 7 rotis (I lost count actually).</p> <p style="margin-bottom:0;">
<br /></p> <p style="margin-bottom:0;">Cheers!</p>
